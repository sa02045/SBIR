# 전송 계층 : 신뢰할 수 있는 데이터 전송하기

# 전송 계층의 역할

## 전송 계층의 두가지 역할

1. 다른 네트워크로 데이터를 전송할 때 라우팅 기능을 사용하여 전송한다
2. 라우팅 정보가 잘못 되어 패킷이 손상되더라도, 물리-데이터링크-네트워크 계층은 아무것도 해주지 않는다
3. `전송계층은 목적지에 신뢰할 수 있는 데이터를 정확하게 전달한다`
   - 오류 점검 기능이 있다
   - 전송된 데이터의 목적지가 어떤 어플리케이션인지 식별한다

- 예를 들어 데이터가 홈페이지에서 사용되야하는데, 이메일 프로그램에 전송되면 안된다

## 연결 통신과 비연결 통신

전송 계층의 특징

1. 신뢰,정확성 : `연결형 통신` TCP
2. 효율성 : `비연결형 통신` UDP

# TCP의 구조

캡슐화 시 TCP로 전송할 때 붙이는 헤더를 `TCP헤더`라고 한다
TCP헤더에 붙은 데이터를 `세그먼트` 라고 한다

1. TCP 프로토콜은 `연결`이라는 가상의 독점 통신로를 확보한 후에 데이터를 전송한다
2. TCP헤더의 `코드비트`에는 연결의 제어 정보가 기록된다
3. 연결을 확립하기 위해서는 `SYN` `ACK`가 필요하다

   - 초기값은 0이고 활성화되면 1이된다
   - SYN은 연결 요청, ACK은 확인 응답이다

## 3-way Handshake

| 신뢰할 수 있는 연결을 하려면 패킷을 `3번` 교환한다

1. 연결확립 요청 (SYN을 보냄)
   - SYN은 1로 활성화 된다
2. 연결확립 응답 + 연결확립 요청 (SYN + ACK을 보냄)
   - SYN과 ACK은 1로 활성화 된다
3. 연결확립 응답 (ACK 보냄)
   - ACK은 1로 활성화 된다

연결을 끊을 때는 `FIN`과 `ACK`를 사용한다

1. 연결 종료 요청(FIN을 활성화한다)- 클라이언트
2. 연결 종료 응답 (ACK) - 서버
3. 연결 종료 요청 (FIN) - 서버
4. 연결 종료 응답 (ACK) - 클라이언트

## 정리

1. 전송계층은 TCP헤더가 붙는다. TCP헤더가 붙은 데이터를 세그먼트라고 한다
2. 3-way handshake 연결을 확립하기 위해 TCP헤더에 있는 코드 비트를 사용한다

3. `SYN`은 연결 요청, `ACK`은 연결 응답, `FIN`은 연결 종료를 뜻한다

# 일련변호와 확인 응답 번호의 구조

## 일련번호와 확인 응답 구조란?

3-way handshake가 끝나고 실제 데이터를 주고받을 때는 TCP헤더의 `sequence number`와 `acknowledgement number`를 사용한다

- 각각 32비트이다

- seq num은 송신측에서 수신측에 이 데이터가 `몇번째 데이터`인지 알려준다
- ack num은 수신측이 몇번째 데이터를 수신했는지 송신측에 알려주는 역할이다
  - 10번 데이터를 수신하면, 다음번 받을 데이터인 11번 데이터를 전송을 요청한다

### 예시

0. 3-way handshake로 연결 수립할 때 일련번호와 확인 응답번호가 수립된다

1. 200바이트 데이터 송신 (클라이언트)

   - 일련번호 3001, 확인 응답번호 4001

2. 서버는 3001번의 데이터를 받았고 200바이트 만큼의 데이터를 받았다. 다음번 받을 데이터는 3201번부터이다
   - 일련번호 4001, 확인 응답번호 3201

### 재전송 제어

| 일련번호와 확인 응답 번호를 사용해서 데이터가 손상되거나 유실된 경우에 데이터를 재전송하게 되어있다

- 오류가 발생하면 일정 시간 동안 대기한 후에 재전송한다

## 윈도우 크기란?

- 세그먼트(TCP헤더가 붙은 데이터) 하나를 보낼 때마다 확인 응답을 한번 반환하는 방식은 효율이 높지 않다
- 세그먼트를 연속해서 보내고 난 다음에 확인 응답을 반환하면 효율이 높아진다
- 받은 쪽에서는 세그먼트를 일시적으로 보관하는 `버퍼`장소에 저장한다
- 만약 세그먼트를 대량으로 받아서 처리하지 못하는 경우는 `오버플로`라고 한다
- 오버플로가 발생하지 않도록 `버퍼의 한계크기`를 알아야하는데 TCP헤더의 `윈도우사이즈`값에 해당한다

| 윈도우 크기는 얼마나 많은 용량의 데이터를 저장해 둘 수 있는지를 나타낸다

- 확인 응답을 하지 않고 연속해서 송수신 할 수 있는 데이터 크기이다

- 윈도우 사이즈 초기값은 3way handshake할 때 서로 판단한다

- 윈도우 사이즈 이내라면 연속해서 데이터를 보낸다

## 정리

1. TCP프로토콜은 재전송 제어를 통해 데이터를 다시 보낸다
2. 수신한 세그먼트를 일시적으로 저장하는 곳을 `버퍼`라고 한다. 버퍼가 넘치는 것을 오버플로라고 한다
3. 3-way handshake를 수립할 때 윈도우 사이즈를 주고받아 서로의 버퍼 크기를 교환한다
4. 상대방의 버퍼크기 이내라면 연속해서 데이터를 전송한다

# 포트 번호의 구조

| TCP프로토콜은 데이터의 목적지가 어떤 애플리케이션인지 구분하는 역할을 한다

- TCP헤더에는 출발지 포트번호, 목적지 포트번호가 있다(16비트)

1. 포트번호는 0~65535번을 사용할 수 있다
2. 0~1023번호는 주요 프로토콜이 사용하도록 예약되어 있다(well-known ports)
3. 1024번은 사용하지 않는 포트고, 1025번 이상은 랜덤포트로 클라이언트의 송신포트로 사용된다

4. HTTP 80포트, HTTPS 443포트, SSH 22포트

# UDP의 구조

TCP의 역할은 `신뢰할 수 있는 데이터를 전송하는 것`이었다

반대로 UDP는 `데이터를 효율적으로 빠르게` 전송하는 것이다

## UDP헤더란?

- UDP헤더가 붙은 데이터를 `UDP 데이터그램`이라고 한다

  - UDP헤더는 TCP헤더에 비해 적은 정보를 담고 있다
  - 출발지, 목적지 포트번호, 길이, 체크섬비트

- UDP는 확인 응답 없이 상대방을 확인하지 않고 연속해서 데이터를 보낸다

- UDP를 사용하면 `브로드캐스트` 할 수 있는데, 랜에 있는 컴퓨터나, 네트워크 장비에 데이터를 일괄적으로 보낼 수 있다

## 정리

1. UDP프로토콜은 데이터를 효율적으로 빠르게 보낼 때 사용되는 프로토콜이다
2. UDP헤더는 매우 간단하다
3. UDP헤더가 붙은 데이터를 UDP데이터그램이라고 한다
4. UDP는 랜에 불특정 다수에게 브로드캐스트로 데이터를 일괄 전송한다

# 복습

1. TCP는 연결형통신, UDP는 비연결형 통신이다
2. TCP헤더가 붙은 데이터를 세그먼트, UDP헤더가 붙은 데이터를 데이터그램이라고 한다
3. 연결확립을 위해 3-way handshake를 통해 코드비트의 `SYN` `ACK`를 교환한다
4. 연결종료를 위해 `FIN` `ACK`를 교환한다
5. TCP는 재전송 제어로 데이터를 재전송한다
6. 받은 세그먼트를 일시적으로 저정하는 곳이 `버퍼`이다. 버퍼가 넘치면 오버플로라고 한다
7. 포트번호는 목적지가 어떤 어플리케이션인지 구분한다
8. 포트번호는 0~65535까지이다
9. 대역폭은 `정해진 시간동안 전송할 수 있는 데이터의 양`이다
